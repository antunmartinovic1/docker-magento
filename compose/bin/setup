#!/bin/bash
set -o errexit

MEM=$(docker info | grep "Total Memory" | cut -d':' -f2 | xargs | sed s/GiB//)
# Docker reports RAM 0.2 less than what it is actually set to
(( $(echo "$MEM < 5.8" | bc -l) )) && echo "There must be at least 6GB of RAM allocated to Docker to continue." && exit

# shellcheck source=../env/db.env
source env/db.env
# shellcheck source=../env/elasticsearch.env
source env/elasticsearch.env
# shellcheck source=../env/magento.env
source env/magento.env
# shellcheck source=../env/rabbitmq.env
source env/rabbitmq.env

DOMAIN=${1:-vivelacar.loc}

echo "Removing and making 'src' directory"
rm -rf src && mkdir src

echo "Cloning from github ..."
bin/download

echo "Copying data from env directory ..."
bin/file-check

docker-compose -f docker-compose.yml up -d
[ $? != 0 ] && echo "Failed to start Docker services" && exit

echo "Waiting for connection to Elasticsearch..."
bin/clinotty timeout $ES_HEALTHCHECK_TIMEOUT bash -c "
    until curl --silent --output /dev/null http://$ES_HOST:$ES_PORT/_cat/health?h=st; do
        printf '.'
        sleep 2
    done"
[ $? != 0 ] && echo "Failed to connect to Elasticsearch" && exit

echo ""
echo "Waiting for connection to RabbitMQ..."
bin/clinotty timeout $RABBITMQ_HEALTHCHECK_TIMEOUT bash -c "
    until curl --silent --output /dev/null http://$RABBITMQ_DEFAULT_USER:$RABBITMQ_DEFAULT_PASS@$RABBITMQ_HOST:$RABBITMQ_MANAGEMENT_PORT/api/aliveness-test/%2F; do
        printf '.'
        sleep 2
    done"
[ $? != 0 ] && echo "Failed to connect to RabbitMQ" && exit

echo 'Copy files to container ...'
bin/copytocontainer --all

echo "Importing database..."
bin/mysql < etc/localhost.sql

echo "Running composer install..."
bin/clinotty composer install

echo "Copying composer files ...."
bin/copyfromcontainer vendor

bin/clinotty chmod u+x bin/magento

echo "Startting Setup Upgrade ..."
bin/clinotty bin/magento setup:upgrade
bin/copyfromcontainer bin
bin/copyfromcontainer pub
bin/copyfromcontainer lib
bin/copyfromcontainer index.php

echo "Re-indexing with Elasticsearch..."
bin/clinotty bin/magento indexer:reindex

echo "Setting basic URL and generating SSL certificate..."
bin/setup-domain "${DOMAIN}"

echo "Installing cron, run 'bin/cron start' to enable..."
bin/clinotty bin/magento cron:install

echo "Turning on developer mode..."
bin/clinotty bin/magento deploy:mode:set developer

mv .vscode src/

bin/restart

echo "Docker development environment setup complete."
echo "You may now access your Magento instance at https://${DOMAIN}/"
